name: Security Auto Fix
on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run security audit
        run: |
          pnpm audit --audit-level moderate --json > audit-results.json
          
      - name: Auto fix vulnerabilities
        run: |
          pnpm audit --fix
          
      - name: Run Snyk test
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json > snyk-results.json
          
      - name: Auto fix Snyk issues
        run: |
          npx snyk fix
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: auto-fix security vulnerabilities'
          title: 'ğŸ”’ Auto Security Fix'
          body: |
            ## ğŸ›¡ï¸ è‡ªåŠ¨å®‰å…¨ä¿®å¤
            
            æ­¤PRåŒ…å«è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤çš„å®‰å…¨æ¼æ´ï¼š
            
            ### ä¿®å¤å†…å®¹
            - ä¾èµ–åŒ…å®‰å…¨æ›´æ–°
            - æ¼æ´è‡ªåŠ¨ä¿®å¤
            - å®‰å…¨é…ç½®ä¼˜åŒ–
            
            ### æ‰«ææŠ¥å‘Š
            è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹Actionsæ—¥å¿—
          branch: security/auto-fix